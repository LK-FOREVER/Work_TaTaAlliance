"use strict";var _typeof2="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof="function"==typeof Symbol&&"symbol"==_typeof2(Symbol.iterator)?function(e){return void 0===e?"undefined":_typeof2(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":_typeof2(e)};!function(){function e(){var e=Math.floor((+new Date-b)/1e3);if("develop"==u&&console.log("----------timing-------------:",e,M,b),h&&!(e<M)){var o={openid:h,game_appid:v,timing:e,sign:y,version:c,platform:S};tt.request({url:l+"/api/dy/online_time",data:o,method:"post",header:{"content-type":"application/x-www-form-urlencoded"},success:function(e){b=+new Date}})}}function o(){w=tt.getLaunchOptionsSync(),"develop"==u&&console.log(w,"tt.getLaunchOptionsSync(111)");var e=w.query;p=w.scene,I=e.clickid?e.clickid:"",console.log("来源抖音的广告id是: "+I),D=e.gdt_vid?e.gdt_vid:"",console.log("来源微信的广告id是: "+D),x=e.clue_token?e.clue_token:"",k=e.ad_id?e.ad_id:"",T=e.creative_id?e.creative_id:"";var o=w.referrerInfo;e.via?(f=e.via?e.via:"test_sub_channel_id",m=e.shareid?e.shareid:0,g=e.sharetype?e.sharetype:""):e.subchid?(f=e.subchid?e.subchid:"test_sub_channel_id",m=e.shareid?e.shareid:0,g=e.sharetype?e.sharetype:""):o&&"string"==typeof o.extraData&&(o.extraData=JSON.parse(o.extraData),f=o.extraData.subchid,m=o.extraData.shareid?o.extraData.shareid:0,g=o.extraData.sharetype?o.extraData.sharetype:""),a=tt.getSystemInfoSync(),S=a.platform,q=a.SDKVersion}function t(e){tt.checkSession({success:function(){if(console.log("重新获取 success-"+h),h){var o={user:{openid:h,sign:y},shareInfo:w.query};e(o)}else L.login(function(o){if(!h)return void tt.showModal({title:"提示",content:"登录异常，请重新打开小游戏4"});e(o)})},fail:function(){"develop"==u&&console.log("重新获取openid fail"),L.login(function(o){h?e(o):tt.showModal({title:"提示",content:"登录异常，请重新打开小游戏3"})})}})}function n(e){var o=new Array;o=e.split("&");for(var t=0;t<o.length;t++){if(""==o[t])return!1;var n=e.split("=");if("chid"==n[0]||"subchid"==n[0]||"shareid"==n[0]||"sharetype"==n[0])return!1}return!0}var a,r,i,d,s=require("./config.js"),c="v1.0",l="",u="develop",p="",f="test_sub_channel_id",g="",m=0,v="",h="",y="",_={},w={},S="",b=0,M=120,q=0,x="",D="",I="",k=0,T=0,L={getDybUserInfo:function(e){console.log(1111111111111),b=+new Date,"develop"==u&&console.log("----------getDybUserInfo-------------"),t(function(o){L.initData(function(e){}),e(o)})},login:function(e){"develop"==u&&console.log(h+"======login========"),tt.login({force:!0,success:function(o){var t={code:o.code,game_appid:v,channel_id:p,sub_channel_id:f,shareid:m,sharetype:g,version:c,gdt:"",platform:S,clue_token:x,click_id:D,dy_click_id:I,ad_id:k,creative_id:T};"develop"==u&&console.log(t,"初始化登陆logins数据"),tt.request({url:l+"/api/dy/get_dy_userinfo",header:{"content-type":"application/x-www-form-urlencoded"},method:"POST",data:t,dataType:"json",success:function(o){if(!o.data.code)return void tt.showModal({title:"提示",content:o.data.msg});var t={};t={openid:o.data.data.openid,sign:o.data.data.sign};var n={user:t,shareInfo:w.query};h=o.data.data.openid,y=o.data.data.sign,_=t,tt.setStorageSync("sop_user",t),e(n)},fail:function(e){console.log("调用失败",e),tt.showModal({title:"提示",content:"登录异常，请重新打开小游戏1"})}})},fail:function(e){console.log("调用失败",e),tt.showModal({title:"提示",content:"登录异常，请重新打开小游戏2"})}})},initData:function(e){"develop"==u&&console.log("----------init_Data-------------");var o={};o.openid=h,o.sign=y,o.game_appid=v,o.channel_id=p,o.sub_channel_id=f,o.version=c,o.platform=S,o.clue_token=x,o.click_id=D,o.dy_click_id=I,tt.request({url:l+"/api/dy/init_data",data:o,method:"post",header:{"content-type":"application/x-www-form-urlencoded"},success:function(e){"develop"==u&&console.log(e.data,"init_data_success"),90009==e.data.data.errcode&&(h="",tt.removeStorageSync("sop_user"),t(function(){})),1==e.data.code&&(M=e.data.data.online_time?e.data.data.online_time:60)}})},createRole:function(e,o){"develop"==u&&console.log("----------roleData-------------"),t(function(){var t={openid:h,game_appid:v,sign:y,gdt:"",version:c,platform:S};return void 0==_typeof2(e.server_id)&&""==String(e.server_id)&&"undefined"==String(e.server_id)?void o({code:0,msg:"服务器ID不正确"}):(t.server_id=e.server_id,void 0!=_typeof2(e.server_name)||""!=String(e.server_name)||"undefined"!=String(e.server_name)?t.server_name=e.server_name:t.server_name="默认区服",void 0==_typeof2(e.role_name)&&""==String(e.role_name)&&"undefined"==String(e.role_name)?void o({code:0,msg:"角色名称不正确"}):(t.role_name=e.role_name,void tt.request({url:l+"/api/dy/create_role",data:t,method:"post",header:{"content-type":"application/x-www-form-urlencoded"},success:function(e){o(e.data),1==e.data.code?tt.request({url:l+"/api/dy/role_login",data:t,method:"post",header:{"content-type":"application/x-www-form-urlencoded"},complete:function(e){}}):o(e.data)},complete:function(){console.log("finshshow-----"),tt.reportAnalytics("finishShow")}})))})},submitOrder:function(e,o){var n=+new Date;console.log("开始时间:",n),"develop"==u&&console.log("----------提交订单-------------支付环境"),t(function(){if(void 0==_typeof2(e.server_name)||""==String(e.server_name)||"undefined"==String(e.server_name))return void o({code:0,msg:"缺少服务器名"});if(void 0==_typeof2(e.role_name)||""==String(e.role_name)||"undefined"==String(e.role_name))return void o({code:0,msg:"缺少角色名"});var t={game_appid:v,extra_info:e.extra_info,goods_count:e.goods_count,goods_name:e.goods_name,pay_amount:e.pay_amount,account_id:h,redirect_uri:e.redirect_uri,role_name:e.role_name,server_name:e.server_name,channel_id:p,sub_channel_id:f,order_sn:e.order_sn,sign:y,gdt:"",version:c,platform:S},a=+new Date-n;console.log("request_before",a),tt.request({url:l+"/api/dy/dygame_create",method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},data:t,success:function(e){var r=+new Date-n;if("develop"==u&&console.log(e.data,"支付接口返回",r),90009==e.data.data.errcode&&(h="",tt.removeStorageSync("sop_user")),e.data.code)2==e.data.data.pay_type?tt.openCustomerServiceConversation({showMessageCard:!0,sendMessageTitle:e.data.data.order_sn,sendMessagePath:JSON.stringify(t),sendMessageImg:l+"/kefuIcon.png",success:function(e){tt.hideLoading(),console.log(e,"客服回调")},fail:function(e){tt.hideLoading(),o({code:0,msg:"取消支付"}),console.log(e,"客服回调fail")}}):1==e.data.data.pay_type?(tt.hideLoading(),tt.navigateToMiniProgram({appId:"wxab2e839b6578e72c",path:"pages/come/come?scene="+e.data.data.id,extraData:{game_appid:v,openid:h},envVersion:"release",success:function(e){tt.hideLoading(),console.log(e,"res")},fail:function(e){tt.hideLoading(),console.log(e,"fff")},complete:function(e){tt.hideLoading()}})):3==e.data.data.pay_type?tt.request({url:l+"/api/dy/native_pay",method:"POST",data:{id:e.data.data.id},header:{"content-type":"application/json"},success:function(e){if(e.data.code){var t=e.data.data.url;console.log(t),o({code:1,msg:"支付链接获取成功",pay_url:t})}}}):4==e.data.data.pay_type?tt.request({url:l+"/api/mini/getUnlimit",method:"POST",data:{scene:e.data.data.id,appid:"wxab2e839b6578e72c"},header:{"content-type":"application/json"},success:function(e){console.log(e,"sss"),e.data.code&&(console.log(l+"/"+e.data.data.url),tt.previewImage({current:l+"/"+e.data.data.url,urls:[l+"/"+e.data.data.url],success:function(e){tt.hideLoading()},fail:function(e){tt.hideLoading(),console.log(e,"prf")}}))}}):"android"==S||"windows"==S?tt.requestGamePayment({mode:e.data.data.param.mode,env:e.data.data.param.env,currencyType:e.data.data.param.currencyType,platform:e.data.data.param.platform,customId:e.data.data.customId,success:function(t){o({code:1,msg:"支付成功"}),"develop"==u&&console.log("支付成功回调函数");var n=0,a=e.data.data.customId,r=setInterval(function(){tt.request({url:l+"/api/dy/dygame_notify",method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},data:{bill_no:a,game_appid:v,account_id:h,sign:y},success:function(e){"develop"==u&&console.log(e.data,"支付成功查询回调"),(1==e.data.code||n>10)&&clearInterval(r),n++},complete:function(e){n>30&&clearInterval(r)}})},2e3)},fail:function(e){"develop"==u&&console.log("支付失败",e),tt.hideLoading(),o({code:0,msg:"支付失败"});var t=+new Date-n;console.log("fail_time",t),e.request_before=a,e.req_success=r,e.failTime=t,e.appid=v,e.openid=h,tt.request({url:l+"/api/dy/fail_pay",method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},data:e,success:function(e){}})}}):(tt.hideLoading(),tt.showModal({title:"提示",content:"请使用手机完成支付",showCancel:!1,cancelColor:"cancelColor"}));else{tt.hideLoading();var i=e.data.data.data;i&&90009==i.errcode&&(h="",tt.removeStorageSync("sop_user")),o({code:0,msg:e.data.msg})}},fail:function(e){o({code:0,msg:"请求失败"})}})})},toMyFavorite:function(e){tt.onFavoriteStateChange(function(o){o?("develop"==u&&console.log("收藏成功"),e({code:1,msg:"收藏成功"})):("develop"==u&&console.log("收藏成功"),e({code:0,msg:"收藏失败"}))})},addShortcut:function(e){(S="android")?tt.checkShortcut({success:function(o){"develop"==u&&console.log("检查快捷方式",o.status),o.status.exist?e({code:2,msg:"已经添加",res:o.errMsg}):tt.addShortcut({success:function(o){"develop"==u&&console.log("添加桌面成功"),e({code:1,msg:"添加桌面成功",res:o.errMsg})},fail:function(o){"develop"==u&&console.log("添加桌面失败",o.errMsg),e({code:0,msg:"添加桌面失败",res:o.errMsg})}})},fail:function(e){console.log("检查快捷方式失败",e.errMsg)}}):tt.addShortcut({success:function(o){"develop"==u&&console.log("添加桌面成功"),e({code:1,msg:"添加桌面成功",res:o.errMsg})},fail:function(o){"develop"==u&&console.log("添加桌面失败",o.errMsg),e({code:0,msg:"添加桌面失败",res:o.errMsg})}})},screenRecord:function(e){tt.getSystemInfo({success:function(o){var t=o.screenWidth,n=o.screenHeight,a=tt.getGameRecorderManager(),r=a.getMark(),i=(t-r.markWidth)/2,d=(n-r.markHeight)/2;a.onStart(function(o){"develop"==u&&console.log("录屏开始"),e({code:2,msg:"录屏开始"})}),a.start({isMarkOpen:!0,locLeft:i,locTop:d}),a.onStop(function(o){"develop"==u&&console.log("录制完成地址",o.videoPath),e({code:3,msg:"录制完成",record_url:o.videoPath}),tt.setStorageSync("dybRecordUrl",o.videoPath)}),a.stop()}})},shareRecordScreen:function(e){var o=tt.getStorageSync("dybRecordUrl");if(""==o)return void e({code:0,msg:"录屏文件不存在"});tt.shareAppMessage({channel:"video",extra:{videoPath:o,withVideoId:!0},success:function(o){e({code:1,msg:"分享成功",res:o})},fail:function(o){e({code:0,msg:"分享失败",res:o})}})},onShare:function(e){if("develop"==u&&console.log("----------设置转发-------------"),e.query&&!n(e.query))return void console.log("query error");tt.showShareMenu({showShareItems:["shareAppMessage","shareTimeline"],withShareTicket:!0}),tt.onShareAppMessage(function(){return{title:e.title,imageUrl:e.imageUrl,query:"subchid="+f+"&sharetype=onshare&shareid="+h+"&"+e.query}})},share:function(e,o){"develop"==u&&console.log("----------主动转发-------------"),t(function(){if(e.query&&!n(e.query))return void console.log("query error");tt.shareAppMessage({title:e.title,desc:e.desc,imageUrl:e.imageUrl,success:function(){o({code:1,msg:"分享成功"})},fail:function(e){console.log("分享失败"),o({code:0,msg:"分享失败",res:e})}})})},dot:function(e,o){var t={game_appid:v,account_id:h,step:e,sign:y,version:c,platform:S};tt.request({url:l+"/api/dy/dot_record",method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},data:t,success:function(e){o(e.data)},fail:function(e){o({code:0,msg:"网络请求失败",res:e})}})},createVideoAd:function(e,o){if(i=!1,"develop"==u&&console.log(void 0===r?"undefined":_typeof2(r),"typeof(video)"),"object"!=(void 0===r?"undefined":_typeof2(r)))"develop"==u&&console.log(d,"typeof(adUnitId11)"),d=e,r=tt.createRewardedVideoAd({adUnitId:e}),r.load().then(function(){console.log("激励视频加载成功"),r.show().then(function(e){L.advertisement("show",function(e){}),console.log("132sdfassf-------------"),o({state:"show",msg:"视频展示成功",isEnded:!1})}).catch(function(e){var t={};t.code=2,t.state="error",t.msg=e.errMsg,t.isEnded=!1,o(e)})}).catch(function(e){console.log("激励视频加载失败",e)}),r.onError(function(e){var t={};"develop"==u&&console.log(e,"----------onError-------------"),t.msg=e.errMsg,t.state="error",t.isEnded=!1,t.res=e,o(t)}),r.onClose(function(e){if(i);else{var t={};L.advertisement("close",function(e){}),t.state="close",t.isEnded=e.isEnded,t.count=e.count,t.msg="视频广告关闭",o(t)}});else if(d!=e){"develop"==u&&console.log(d,e,"typeof(new)"),d=e;var t=tt.createRewardedVideoAd({adUnitId:e});t.load().then(function(){t.show().then(function(e){L.advertisement("show",function(e){}),o({state:"show",msg:"视频展示成功",isEnded:!1})}).catch(function(e){var t={};t.code=2,t.state="error",t.msg=e.errMsg,t.isEnded=!1,o(e)})}).catch(function(e){console.log("激励视频加载失败",e)}),t.onError(function(e){var t={};"develop"==u&&console.log(e,"----------onError-------------"),t.msg=e.errMsg,t.state="error",t.isEnded=!1,t.res=e,o(t)})}else"develop"==u&&console.log(r,"----------createVideoAd-------------"),r.show().then(function(e){L.advertisement("show",function(e){}),o({state:"show",msg:"视频展示成功",isEnded:!1})}).catch(function(e){var t={};t.code=2,t.state="error",t.msg=e.errMsg,t.isEnded=!1,o(e)})},advertisement:function(e,o){"develop"==u&&console.log(e,"----------上报广告-------------"),t(function(){var t={openid:h,game_appid:v,sign:y,version:c,platform:S},n="";"show"==e?n=l+"/api/dy/videoClick":"close"==e?n=l+"/api/dy/watch":"share"==e&&(n=l+"/api/dy/share"),tt.request({url:n,data:t,method:"post",header:{"content-type":"application/x-www-form-urlencoded"},complete:function(e){o(e.data)}})})},gameLevel:function(e,o){var t={};t.openid=h,t.appid=v,t.sign=y,t.level=e,t.version=c,t.platform=S,tt.request({url:l+"/api/dy/game_level",data:t,method:"post",header:{"content-type":"application/x-www-form-urlencoded"},complete:function(e){o(e.data)}})},msg_check:function(e,o){var t={};t.content=e,t.appid=v,t.openid=h,t.version=c,tt.request({url:l+"/api/dy/msg_sec_check",data:t,method:"post",header:{"content-type":"application/x-www-form-urlencoded"},success:function(e){o(e.data)}})}};!function(){_=tt.getStorageSync("sop_user"),h=_.openid,y=_.sign,console.log("==dysdk version==",c),u=s.env,l=s.url,v=s.appid,o(),tt.onHide(function(){console.log("onhide",b),e(),b=+new Date}),tt.onShow(function(e){b=+new Date,console.log(JSON.stringify(e),"show");var o=e.referrerInfo;console.log(o,"refer")}),window.dyb=L}()}();